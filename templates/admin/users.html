{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark">User Management</h2>
    <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
        <i class="fas fa-user-plus me-2"></i> Create New Employee
    </button>
</div>

{% if request.query_params.success %}
<div class="alert alert-success">{{ request.query_params.success }}</div>
{% endif %}
{% if request.query_params.error %}
<div class="alert alert-danger">{{ request.query_params.error }}</div>
{% endif %}

<div class="card-custom p-0 bg-white border shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Name / ID</th>
                    <th>Designation</th>
                    <th>Department</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users_list %}
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle text-white small d-flex align-items-center justify-content-center me-3"
                                style="width:35px;height:35px;">
                                {{ u.full_name[0] | upper }}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">{{ u.full_name }}</div>
                                <div class="small text-muted">{{ u.employee_id or 'No ID' }}</div>
                                <div class="small text-muted" style="font-size: 0.75rem;">{{ u.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td>{{ u.designation or '-' }}</td>
                    <td>
                        <div>{{ u.department or '-' }}</div>
                        <small class="text-muted">{{ u.sub_department or '' }}</small>
                    </td>
                    <td>
                        {% if u.role == 'super_admin' %}<span class="badge bg-danger">Super Admin</span>
                        {% elif u.role == 'admin' %}<span class="badge bg-warning text-dark">Admin</span>
                        {% else %}<span class="badge bg-info text-dark">Employee</span>{% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" data-user-id="{{ u.id }}"
                                data-user-name="{{ u.full_name }}" data-user-empid="{{ u.employee_id or '' }}"
                                data-user-desig="{{ u.designation or '' }}" data-user-dept="{{ u.department }}"
                                data-user-subdept="{{ u.sub_department or '' }}" data-user-role="{{ u.role }}"
                                onclick="openEditModal(this)">
                                <i class="fas fa-edit"></i>
                            </button>

                            <form action="/admin/users/delete" method="POST"
                                onsubmit="return confirm('Are you sure you want to delete this user? This cannot be undone.');">
                                <input type="hidden" name="user_id" value="{{ u.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i
                                        class="fas fa-trash"></i></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="/admin/users/create" method="POST">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Onboard New Employee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Full Name</label>
                            <input type="text" name="full_name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Employee ID</label>
                            <input type="text" name="employee_id" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email Address</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Designation</label>
                            <input type="text" name="designation" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Department</label>
                            <select id="createDeptSelect" name="department" class="form-select"
                                onchange="filterSubDepts('createDeptSelect', 'createSubSelect')" required>
                                <option value="">Select...</option>
                                {% for dept in departments %}
                                <option value="{{ dept.name }}" data-id="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Sub-Department</label>
                            <select id="createSubSelect" name="sub_department" class="form-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Role</label>
                            <select name="role" class="form-select">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Password</label>
                            <input type="text" name="password" class="form-control" value="Welcome@2026" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="/admin/users/update" method="POST">
            <input type="hidden" name="user_id" id="editUserId">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Edit Employee Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Full Name</label>
                            <input type="text" name="full_name" id="editName" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Employee ID</label>
                            <input type="text" name="employee_id" id="editEmpId" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Designation</label>
                            <input type="text" name="designation" id="editDesig" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Role</label>
                            <select name="role" id="editRole" class="form-select">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Department</label>
                            <select id="editDeptSelect" name="department" class="form-select"
                                onchange="filterSubDepts('editDeptSelect', 'editSubSelect')" required>
                                <option value="">Select...</option>
                                {% for dept in departments %}
                                <option value="{{ dept.name }}" data-id="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Sub-Department</label>
                            <select id="editSubSelect" name="sub_department" class="form-select">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning fw-bold">Update Details</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Master Data for Sub-Departments - using JSON.parse to avoid parser errors
    const subDepts = JSON.parse(`[
        {% for dept in departments %}
            {% for sub in dept.sub_departments %}
                {"deptId": "{{ dept.id }}", "name": "{{ sub.name }}"}{{ "," if not loop.last else "" }}
            {% endfor %}{{ "," if not loop.last else "" }}
        {% endfor %}
    ]`);

    // Generic function to filter sub-departments
    function filterSubDepts(deptSelectId, subSelectId) {
        const deptSelect = document.getElementById(deptSelectId);
        const subSelect = document.getElementById(subSelectId);
        const selectedOption = deptSelect.options[deptSelect.selectedIndex];
        const selectedDeptId = selectedOption.getAttribute('data-id');

        // Clear current options
        subSelect.innerHTML = '<option value="">Select Sub-Department...</option>';

        if (selectedDeptId) {
            const relevantSubs = subDepts.filter(sub => sub.deptId === selectedDeptId);
            relevantSubs.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.name;
                option.textContent = sub.name;
                subSelect.appendChild(option);
            });
        }
    }

    // Function to Populate Edit Modal
    function openEditModal(button) {
        // Extract data from button's data attributes
        const id = button.getAttribute('data-user-id');
        const name = button.getAttribute('data-user-name');
        const empId = button.getAttribute('data-user-empid');
        const desig = button.getAttribute('data-user-desig');
        const dept = button.getAttribute('data-user-dept');
        const subDept = button.getAttribute('data-user-subdept');
        const role = button.getAttribute('data-user-role');

        document.getElementById('editUserId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editEmpId').value = empId;
        document.getElementById('editDesig').value = desig;
        document.getElementById('editRole').value = role;

        // Set Department
        const deptSelect = document.getElementById('editDeptSelect');
        deptSelect.value = dept;

        // Trigger change to populate sub-departments, then select the correct sub-dept
        filterSubDepts('editDeptSelect', 'editSubSelect');

        // Slight delay to ensure options are populated before selection
        setTimeout(() => {
            document.getElementById('editSubSelect').value = subDept;
        }, 50);

        // Open Modal
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    }
</script>
{% endblock %}